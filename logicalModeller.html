<!DOCTYPE html>
<html>
<head lang="en">
    <base href="/" />
    <meta charset="UTF-8">
    <script src="js/libs/jquery-1.9.0.min.js"></script>
    <script src="js/libs/angular.min1-5.js"></script>
    <script src="js/libs/ui-bootstrap-tpls-2.0.1.min.js"></script>
    <script src="js/libs/lodash.js"></script>

    <script src="js/libs/moment.min.js"></script>

    <link rel="stylesheet" type="text/css" href="css/jsTreeStyle.css"/>
    <link rel="stylesheet" type="text/css" href="css/jsTreeThemes/proton/style.css"/>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="stylesheet" type="text/css" href="css/vis.min.css"/>

    <link rel="stylesheet" type="text/css" href="css/angular-lightweight-markdown-editor.css"/>

    <script src="js/libs/angular-sanitize.js"></script>
    <script src="js/libs/jstree.min.js"></script>

    <script src="js/libs/firebase.js"></script>
    <script src="js/libs/angularfire.min.js"></script>

    <style>
        #mmLogicalModel {
            width: 100%;
            height: 600px;
            border: 1px solid lightgray;
        }

        #refLogicalModel {
            width: 100%;
            height: 400px;
            border: 1px solid lightgray;
        }

        #resourceGraph {
            width: 100%;
            height: 600px;
            border: 1px solid lightgray;
        }

        markdown-editor {
            border: 1px solid #ccc;
            border-radius: 2px;
        }

        .designerScroll {
            height: 900px;
            overflow-y: scroll;
        }



        .subTabScroll {
            height: 700px;
            overflow-y: scroll;
        }


        .present {
            color:green;
        }

        .absent {
            color:red;
        }

        /* These seem only to apply to the markdown generated html (which is the intention*/

        /*
        h1 {

            font-family: 'Titillium Web', sans-serif, Arial, sans-serif;
            color:rebeccapurple;
        }

        h2 {
            border-top: 1px solid lightgray;
            margin-left: 8px;
            font-family: 'Titillium Web', sans-serif, Arial, sans-serif;
            color: red;
        }

        h3 {
            margin-left: 16px;
            font-family: 'Titillium Web', sans-serif, Arial, sans-serif;
            color:blue;
        }
        p {
            margin-left: 20px;
            font-family: 'Titillium Web', sans-serif, Arial, sans-serif;

        }

*/

    </style>

    <script>

        //https://github.com/rallu/angular-lightweight-markdown-editor
        angular.module("sampleApp",['ui.bootstrap','ngStorage',"firebase","ngSanitize",'ui.checkbox',
            "angular-lightweight-markdown-editor"]).config(function($locationProvider) {

            // enable html5Mode for pushstate ('#'-less URLs)
            $locationProvider.html5Mode(true);
            $locationProvider.hashPrefix('!');
        });
        angular.module("sampleApp").constant("moment", moment);

        angular.module("sampleApp").config(['$compileProvider', function ($compileProvider) {
            $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob):/);
        }]);
/*

//http://www.webdeveasy.com/interceptors-in-angularjs-and-useful-examples/
        angular.module('sampleApp').factory('sessionRecoverer', ['$q', '$injector', function($q, $injector) {
            var sessionRecoverer = {
                responseError: function(response) {
                    // Session has expired

                    console.log('intercept HTTP error! '+ response.status)

                    if (response.status == 401){
                        var projectService = $injector.get('projectSvc');
                        var $http = $injector.get('$http');
                        var deferred = $q.defer();

                        // generate a new token

                        projectService.refresh().then(deferred.resolve, deferred.reject);

                        // When the session recovered, make the same backend call again and chain the request
                        return deferred.promise.then(function() {
                            return $http(response.config);
                        });
                    }

                    return $q.reject(response);
                }
            };
            return sessionRecoverer;
        }]);

        angular.module('sampleApp').config(['$httpProvider', function($httpProvider) {
            $httpProvider.interceptors.push('sessionRecoverer');
        }]);
*/


        window.onerror = function(message, url, linenumber) {
            alert("An unexpected error occurred: " + message + " on line " + linenumber + " for " + url);
        }


    </script>

    <script src="js/libs/angular-bootstrap-checkbox.js"></script>

    <script src="js/logicalModellerCtrl.js"></script>
    <script src="js/modalDialogSvc.js"></script>
    <script src="js/resourceSvc.js"></script>
    <script src="js/services.js"></script>
    <script src="js/profileCreatorSvc.js"></script>
    <script src="js/resourceCreatorSvc.js"></script>
    <script src="js/filters.js"></script>

    <script src="resourceBuilder/rbServices.js"></script>

    <script src="js/libs/ngStorage.min.js"></script>
    <script src="js/appConfigSvc.js"></script>
    <script src="js/logicalModelSvc.js"></script>

    <script src="js/libs/vis.min.js"></script>
    <script src="js/loginCtrl.js"></script>
    <script src="js/fileCopyCtrl.js"></script>

    <script src="resourceBuilder/vsBrowser.js"></script>
    <script src="js/modellerFilters.js"></script>
    <script src="js/igSvc.js"></script>
    <script src="js/newVSFinder.js"></script>
    <script src="js/libs/showdown.min.js"></script>
    <script src="js/libs/angular-lightweight-markdown-editor.min.js"></script>
    <script src="resourceBuilder/selectProfile.js"></script>
    <script src="js/setServers.js"></script>
    <script src="js/securitySvc.js"></script>
    <script src="js/editLogicalNodeCtl.js"></script>

    <script src="js/components/extensionDirective.js"></script>
    <script src="js/newExtensionDefinitionCtrl.js"></script>
    <script src="js/edBuilderSvc.js"></script>
<!--
 <script src="js/editLMDocCtl.js"></script>
    <script src="js/questionnaireSvc.js"></script>

    <script src="directive/questionnaire/questionnaireCtl.js"></script>
-->
    <script src="js/newBuilderCtl.js"></script>
    <script src="js/newBuilderSvc.js"></script>

    <script src="js/builderSvc.js"></script>
    <script src="directive/lmPopulator/lmPop.js"></script>


    <script src="js/addPropertyInBuilderCtrl.js"></script>
    <script src="js/sbHistorySvc.js"></script>
    <script src="js/dataTypeCtrl.js"></script>
    <script src="js/profileDiffSvc.js"></script>
    <script src="js/projectSvc.js"></script>
    <script src="js/lmFilterCtrl.js"></script>
    <script src="js/lmFilterSvc.js"></script>
    <script src="js/autoFocus.js"></script>
    <script src="js/task.js"></script>
    <script src="js/taskSvc.js"></script>



    <script>
        var config = {
            apiKey: "AIzaSyBNMohLbPiSKwpGwfARopdeW_6LLXujcUo",
            authDomain: "clinfhir.firebaseapp.com",
            databaseURL: "https://clinfhir.firebaseio.com",
            storageBucket: ""
        };

        //  console.log(firebase)
        if (firebase) {
            firebase.initializeApp(config);

        }
    </script>

    <title>Logical Modeller</title>


</head>


<body style="padding: 8px;padding-top: 80px" >

<div ng-app="sampleApp" ng-controller="logicalModellerCtrl" class="container-fluid">

    <div ng-class="{applyPadding : ! startupParams.hideNav}" >
        <!-- Hide the nav bar if the 'hideNav' query parameter is set in the call-->
        <nav ng-hide="startupParams.hideNav" class="navbar navbar-default navbar-fixed-top" role="navigation">

            <div class="container-fluid">
                <div class="col-md-3 col-sm-3">
                    <span>
                        <a class="navbar-brand" href="#" ng-click="showVersion()">
                            Logical Modeller: {{currentType.url | getLogicalID}}

                        </a>
                    </span>
                    <span>

                    </span>

                </div>
                <div class="col-md-2 col-sm-2">

                    <span style="cursor:pointer"

                          uib-popover-html="displayServers()"
                          popover-trigger="'mouseenter'"
                          popover-placement="bottom"
                           class="navbar-text pull-right"> {{appConfigSvc.getCurrentConformanceServer().name}}</span>


                </div>

                <div class="col-md-1 col-sm-1">
                    <form class="navbar-form navbar-left">
                        <img ng-show="showWaiting" src="css/ajax_loader_blue_32.gif"/>

                        <span ng-show="history.length > 0"  style="font-size:1.8em; cursor: pointer" ng-click="goBack()">
                            <i class="glyphicon glyphicon-backward"></i>
                        </span>

                    </form>


                </div>

                <div class="col-md-5 col-sm-5">
                    <div ng-hide = "loadedFromBookmark">
                        <div class="navbar-text clickable" ng-show="LMSelectorVisible" ng-click="hideLMSelector()">Hide Selector</div>
                        <div class="navbar-text clickable" ng-hide="LMSelectorVisible" ng-click="showLMSelector()">Show Selector</div>
                    </div>

                    <div class="navbar-text clickable" ng-show="LMDetailVisible" ng-click="hideDetailSelector()">Hide Detail</div>
                    <div class="navbar-text clickable" ng-hide="LMDetailVisible" ng-click="showDetailSelector()">Show Detail</div>
<!--

                    <div class="navbar-text clickable" ng-show="input.showComments" ng-click="input.showComments = ! input.showComments">Hide Comments</div>
                    <div class="navbar-text clickable" ng-hide="input.showComments" ng-click="input.showComments = ! input.showComments">Show Comments</div>
-->
                    <form ng-show="isDirty" class="navbar-form">
                        <button ng-show="isDirty && canSaveModel"
                                class="btn btn-success pull-right" ng-click="saveModel()">Save model</button>
                    </form>

                    <form ng-show="SD && !loadedFromBookmark && !treeData.shortCut.shortCut" class="navbar-form">
                        <button class="btn btn-success pull-right iconSpacing" ng-click="generateShortCut()">Share</button>
                    </form>
                </div>

                <div class="col-md-1 col-sm-1">

                    <div class="nav navbar-form navbar-right" ng-hide="Practitioner">
                        <span style="font-size:1.8em; cursor: pointer"uib-popover="Click to log in"
                              popover-placement="left"
                              popover-trigger="'mouseenter'">
                            <div ng-click="login()">
                                <i class="glyphicon glyphicon-log-in"></i>
                            </div>
                        </span>
                    </div>

                    <div class="nav navbar-form navbar-right" ng-show="Practitioner">
                        <span style="font-size:1.8em; cursor: pointer"
                              uib-popover="Current user: {{Practitioner.telecom[0].value}}. Click to log out"
                              popover-placement="left"
                              popover-trigger="'mouseenter'">

                            <div href="#" ng-click="logout()"> <i class="glyphicon glyphicon-log-out"></i></div>
                        </span>
                    </div>
                </div>

            </div>
        </nav>

    </div>

    <div class="row" ng-show="showNotLoggedIn">
        <div class="col-md-12 col-sm-12">
            <!--  ?? why hide if a practitioner<div ng-hide="Practitioner" class="alert alert-warning">-->
            <div class="alert alert-warning">
                <p>As you have not logged in, you are able to view Models, but not edit them.
                To log in, click the  <i class="glyphicon glyphicon-log-in"></i>  icon to the upper right. You can create an account there if you don't already
                    have one - all you need is an email address.</p>
            </div>
        </div>
    </div>





    <div class="row">
        <div ng-class="leftPaneClass">
            <div class="row">
                <div class="col-md-8 col-sm-8">
                    <h4>Model Selector</h4>
                </div>
                <div class="col-md-4 col-sm-4">

                    <button ng-show="Practitioner" class="btn btn-link pull-right" ng-click="newModel()">New Model</button>


                </div>
            </div>


            <uib-tabset>

                <uib-tab heading="Palette" >

                    <ul class="list-group" style=" height:500px; overflow: auto;" >
                        <li style="cursor: pointer" ng-class="{'list-group-item':1==1,'list-group-item-info':SD.id == entry.item.display}"
                            ng-repeat="entry in lmPalette.entry"
                            ng-click="selectFromPalette(entry.item)">

                            <div class="row">
                                <div class="col-md-9 col-sm-9">
                                    <h4>{{entry.item.reference | getLogicalID}}</h4>
                                </div>

                            </div>

                            {{entry.resource.description | limitTo : 200}}
                        </li>
                    </ul>


                </uib-tab>
                <uib-tab heading="All">

                    <div><input type="text" class="form-control" placeholder="Filter model list by id" ng-model="input.filter" ng-change="filterModelList(input.filter)"/> </div>

                    <ul class="list-group" style=" height:700px; overflow: auto;" >
                        <li style="cursor: pointer" ng-class="{'list-group-item':1==1,'list-group-item-info':SD.id == entry.resource.id}"
                            ng-repeat="entry in bundleModels.entry"
                            ng-click="selectModel(entry,$index)">

                            <div class="row">
                                <div class="col-md-9 col-sm-9">
                                    <h4>{{entry.resource.name}}</h4>
                                </div>
                                <div class="col-md-3 col-sm-3">
                                    <em class="pull-right">{{entry.resource.status}}</em>
                                </div>
                            </div>

                            {{entry.resource.description | limitTo : 200}}
                        </li>
                    </ul>

                </uib-tab>



            </uib-tabset>



        </div>
        <div ng-class="midPaneClass">



            <div ng-show="isHistory" class="alert alert-warning">
                <div class="row">
                    <div class="col-sm-6 col-md-6">
                        <strong>Viewing history: </strong><span>{{SD.meta.lastUpdated | getAgeSeconds}} ago</span>
                    </div>
                    <div class="col-sm-6 col-md-6">
                        <div class="clickable pull-right" ng-click="exitHistory()">Back to current</div>
                        <br/>
                        <div ng-show="canEdit()" class="clickable pull-right" ng-click="revert()">Revert to this version</div>
                    </div>
                </div>
            </div>

            <uib-tabset ng-show="treeData.length > 0">
                <uib-tab heading="Designer">




                    <div class="row">
                        <div class="col-md-12 col-sm-12">
                             <span class="pull-right">
                                 <button class="btn btn-link" ng-click="expandAll()">Expand All</button>
                                 <button class="btn btn-link" ng-click="resetLayout()">Collapse Layout</button>
                               <!--  <button class="btn btn-link" ng-click="showQuest()">Form</button>-->
                                 <button ng-hide="isInPalette || isDirty" class="btn btn-link" ng-click="addToPalette()">Add to Palette</button>
                                 <button ng-show="isInPalette" class="btn btn-link" ng-click="removeFromPalette()">Remove from Palette</button>


                                 <a class="btn btn-link pull-right" download="{{downloadSDJsonName}}"
                                    href="{{downloadSDJsonContent}}" title="{{downloadSDJsonName}}" >
                                    Download SD
                                </a>


                            </span>

                        </div>
                    </div>
                    <div class="designerScroll" id="lmTreeView"></div>
                </uib-tab>

                <uib-tab heading="Table">
                    <br/>

                    <div class="row">
                        <div class="col-sm-6 col-md-6">

                        </div>
                        <div class="col-sm-6 col-md-6">
                            <div>
                                <a class="btn btn-link pull-right" download="{{downloadLinkJsonName}}"
                                   href="{{downloadLinkJsonContent}}" title="{{downloadLinkJsonName}}" >
                                    Download CSV
                                </a>
                            </div>
                        </div>
                    </div>




                    <div class="designerScroll">



                    <table class="table table-bordered table-condensed">
                        <tr><th>Element</th><th>DataType</th><th>Mult.</th><th>Description</th><th>Comment</th></tr>
                        <tr ng-repeat="row in treeData">

                            <td>

                                <div  ng-style="{ 'padding-left': (row.data.path | pathindent) }"
                                        ng-click="selectNodeFromTable(row.data.path)" class="clickable" >{{row.data.path| lastInPath}}</div>
                            </td>
                            <td>{{row.data.type[0].code}}

                                <div ng-show="row.data.type[0].targetProfile">-> {{row.data.type[0].targetProfile | getLogicalID}}</div>

                                <div ng-repeat="map in row.data.ed.mapping">
                                    <em><span ng-show="map.identity == 'fhir'">{{map.map | showMapOnly}}</span></em>
                                </div>


                            </td>

                            <td>{{row.data.min}}..{{row.data.max}}</td>
                            <td>{{row.data.description}}</td>
                            <td>{{row.data.ed.comment}}</td>
                        </tr>

                    </table>

                    </div>


                </uib-tab>


                <uib-tab heading="Analysis">
                    <uib-tabset>
                        <br/>
                        <uib-tab heading="Mapping">
                            <br/>

                            <uib-tabset>
                                <uib-tab heading="Mapping by Element">


                                    <div class="designerScroll">

                                    <table class="table table-bordered table-condensed">
                                        <tr><th></th><th>Element</th><th>DataType</th><th>Mult.</th>
                                            <th>Description & Comments </th>
                                          <!--  <th>Comments</th> -->
                                            <th>Mapping notes</th></tr>
                                        <tr ng-repeat="ed in SD.snapshot.element">
                                            <td>{{$index}}</td>
                                            <td>
                                                <div  ng-click="selectNodeFromTable(ed.path)" class="clickable"
                                                      ng-style="{ 'padding-left': (ed.path | pathindent) }">{{ed.path | lastInPath}}</div>
                                            </td>
                                            <td>{{ed.type[0].code}}
                                                <div ng-show="ed.type[0].targetProfile">-> {{ed.type[0].targetProfile | getLogicalID}}</div>
                                            </td>
                                            <td>{{ed.min}}..{{ed.max}}</td>
                                            <td>{{ed.definition}}
                                                <div>{{ed.comment}}</div>
                                            </td>

                                            <td>
                                                <div ng-repeat="map in ed.mapping">{{map.identity}}:{{map.map | showMapOnly}}</div>

                                                <div ng-show="ed.fixedString">
                                                    Fixed: {{ed.fixedString}}
                                                </div>

                                                <div>

                                                    <a href="#" ng-click="showExtensionFromMap(ed)">

                                                        {{ed | getSingleExtensionValueString : appConfigSvc.config().standardExtensionUrl.simpleExtensionUrl}}
                                                    </a>


                                                </div>



                                            </td>
                                        </tr>

                                    </table>

                                    </div>


                                </uib-tab>



                                <uib-tab heading="Mappings by Identity">
                                    <br/>
                                    <div class="btn-group">
                                        <label ng-repeat="identity in allMappingIdentities"
                                               class="btn btn-default" ng-model='input.mi' uib-btn-radio="identity">
                                            {{identity}}
                                        </label>
                                    </div>
                                    <br/> <br/>

                                    <div class="subTabScroll">
                                        <table class="table table-condensed table-bordered">
                                            <tr><th>Identity</th><th>Path</th><th>Map</th></tr>
                                            <tr ng-repeat="map in allMappings" ng-show="map.identity == input.mi">

                                                <td>
                                                    {{map.identity}}
                                                </td>



                                                <td class="clickable" ng-click="selectNodeFromTable(map.path)">
                                                    {{map.name}}</td>
                                                <td>{{map.map}}</td>
                                            </tr>
                                        </table>
                                    </div>


                                </uib-tab>

                                <uib-tab heading="v2 -> FHIR">
                                    <h4>Mappings that have both an HL7 v2 and a FHIR mapping</h4>

                                    <table class="table table-bordered table-condensed">
                                        <tr><th>HL7 V2</th><th>FHIR</th><th>Path</th></tr>
                                        <tr ng-repeat="map in relativeMappings">
                                            <td>{{map.sourceMap | addSpace}}</td>
                                            <td>{{map.targetMap | addSpace}}</td>
                                            <td>{{map.branch.data.path | addSpace}}</td>
                                        </tr>
                                    </table>

                                </uib-tab>

                            </uib-tabset>


                        </uib-tab>

                        <uib-tab heading="Coded">
                            <br/>
                            <div class="designerScroll">
                                <div class="row">
                                    <div class="col-md-12 col-sm-12">
                                        <table class="table table-bordered table-condensed">
                                            <tr><th>Element</th><th>ValueSet</th><th>Description</th></tr>
                                            <tr ng-repeat="row in treeData" ng-show="row.data.isCoded">
                                                <td>

                                                    <div  ng-click="selectNodeFromTable(row.data.path)" class="clickable" >{{row.data.path}}</div>
                                                </td>
                                                <td>

                                                    <div class="clickable" ng-click="viewVS(row.data.selectedValueSet.valueSet)"
                                                        ng-show="row.data.selectedValueSet.valueSet">
                                                        {{row.data.selectedValueSet.valueSet}}

                                                        <div>({{row.data.selectedValueSet.strength}})</div>

                                                    </div>

                                                </td>
                                                <td>{{row.data.description}}</td>

                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </uib-tab>

                        <uib-tab heading="Check Server">
                            <div class="pull-right">
                                <button class="btn btn-link" ng-click="checkValueSetsOnServer()">Refresh</button>
                            </div>
                            <div class="clearfix"></div>

                            <div class="alert alert-warning" ng-show="checkingVSs">
                                Checking the terminology servers for all the ValueSets in the model. Please wait (this can take a while)...
                            </div>

                            <div class="designerScroll">
                                <table class="table table-bordered">
                                    <tr><th>Path</th><th>ValueSet url</th><th>CodeSystems</th><th>Outcome</th></tr>
                                    <tr ng-repeat="row in vsChecks">
                                        <td><span class="clickable" ng-click="selectNodeFromServerCheck(row.row)">{{row.path}}</span></td>
                                        <td>

                                            <div class="clickable" ng-click="viewVS(row.url)">
                                                 {{row.url}}
                                            </div>
                                        </td>
                                            <div><em>{{row.vs.description}}</em></div>


                                        </td>
                                        <td>
                                            <div ng-repeat="cs in row.cs">{{cs}}</div>
                                        </td>

                                        <td ng-class="{absent:row.absent,present:row.present}">{{row.outcome}}</td>
                                    </tr>
                                </table>
                                <div><em>This table only includes elements for which there is a terminology binding</em></div>
                            </div>

                        </uib-tab>

                        <uib-tab heading="Extensions">
                            <br/>
                            <table class="table table-bordered table-condensed">
                                <tr><th>Element</th><th>Url</th><th>Description</th></tr>
                                <tr ng-repeat="row in treeData" ng-show="row.data.isExtension">
                                    <td>
                                        <div  ng-click="selectNodeFromTable(row.data.path)" class="clickable" >{{row.data.path}}</div>
                                    </td>
                                    <td>
                                        <div class="clickable" ng-click="editExtension(row.data.fhirMappingExtensionUrl)">{{row.data.fhirMappingExtensionUrl}}</div>

                                    </td>
                                    <td>{{row.data.description}}</td>

                                </tr>
                            </table>

                        </uib-tab>


                        <uib-tab heading="Must Support">
                            <br/>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="pull-right">
                                        <input type="checkbox" ng-model="input.showMustSupportOnly"/>
                                        Show 'Must Support' only
                                    </div>


                                </div>
                            </div>

                            <div class="designerScroll">

                                <table class="table table-bordered table-condensed">
                                    <tr><th>Element</th><th>Description</th><th>Must Support</th></tr>

                                    <tr ng-repeat="row in treeData"
                                        ng-hide="$index==0 || (input.showMustSupportOnly && ! row.data.mustSupport)">

                                        <td>
                                            <div ng-click="selectNodeFromTable(row.data.path)"
                                                 class="clickable" >{{row.data.path | dropFirstInPath}}</div>
                                        </td>

                                        <td>{{row.data.description}}</td>
                                        <td>{{row.data.mustSupport}}</td>

                                    </tr>
                                </table>
                            </div>

                        </uib-tab>

                        <uib-tab heading="Status">
                            <br/>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="pull-right">
                                        <input type="checkbox" ng-model="input.hideIncludedStatus"/>
                                        Hide included
                                    </div>

                                    <div class="pull-right">
                                        <input type="checkbox" ng-model="input.showIncludedStatusOnly"/>
                                        Show included only
                                    </div>

                                </div>
                            </div>

                            <div class="designerScroll">

                                <table class="table table-bordered table-condensed">
                                <tr><th>Element</th><th>Status</th></tr>
                                <tr ng-repeat="row in treeData"
                                    ng-show="showStatus(row)">
                                    <td>
                                        <div ng-click="selectNodeFromTable(row.data.path)" class="clickable" >{{row.data.path | dropFirstInPath}}</div>
                                    </td>
                                    <td>{{row.data.edStatus}}</td>

                                </tr>
                            </table>
                            </div>

                        </uib-tab>



                        <uib-tab heading="Mind Map"  select="redrawProfileGraph()"  deselect="input.graphTabIsSelected = false">
                            <div>
                                <div class="pull-right clickable"  ng-click="resetGraph()">Refresh Graph (this can take a few seconds)</div>
                            </div>

                            <br/>



                            <div id="mmLogicalModel"></div>

                        </uib-tab>



                    </uib-tabset>
                </uib-tab>


                <uib-tab heading="Errors" ng-show="error">
                    <pre>{{error.data | json}}</pre>
                </uib-tab>

                <uib-tab heading="Doc">
                    <br/>
                    <div class="pull-right">
                        <button class="btn btn-link " ng-click="updateDoc()">Update</button>

                        <a ng-show="downloadLinkDocName" class="btn btn-link pull-right" download="{{downloadLinkDocName}}"
                           href="{{downloadLinkDoc}}" title="{{downloadLinkDocName}}" >
                            Download HTML file
                        </a>


                    </div>

                    <uib-tabset>

                        <uib-tab heading="Html">
                            <br/>

                            <iframe id="htmlDoc" width="100%" height = "600px"></iframe>

                        </uib-tab>

                        <uib-tab heading="Edit">
                            <br/>
                            <div class="designerScroll">
                                <table class="table table-bordered table-condensed">
                                    <tr><th>Element</th><th>Description</th><th>Comments</th><th>Usage Notes</th></tr>
                                    <tr ng-repeat="row in treeData">

                                        <td>

                                            <div  ng-style="{ 'padding-left': (row.data.path | pathindent) }"
                                                  ng-click="selectNodeFromTable(row.data.path)" class="clickable" >{{row.data.path| lastInPath}}</div>
                                        </td>


                                        <td>{{row.data.description}}</td>
                                        <td>{{row.data.comments}}</td>
                                        <td>{{row.data.usageGuide}}</td>
                                        <td><i class="glyphicon glyphicon-edit clickable" ng-click="lmEditElementDoc(row)"></i></td>
                                    </tr>

                                </table>
                            </div>

                        </uib-tab>

                    </uib-tabset>


                </uib-tab>

                <uib-tab heading="DD">
                    <br/>
                    <div class="pull-right">
                        <button class="btn btn-link " ng-click="updateDD()">Update</button>
                    </div>


                    <uib-tabset>
                        <uib-tab heading="DD layout">
                            <div class="designerScroll">
                                <table class="table table-bordered">
                                <tr ng-repeat = "element in DD">

                                    <td>

                                        <div  ng-style="{ 'padding-left': (element | DDindent) }"
                                              ng-click="selectNodeFromTable(element.path)" class="clickable" >
                                            {{element.path}}
                                        </div>
                                    </td>



                                    <td>{{element.type}}</td>
                                </tr>
                            </table>
                            </div>
                        </uib-tab>

                        <uib-tab heading="Html">
                            <br/>

                            <iframe id="htmlDD" width="100%" height = "600px"></iframe>

                        </uib-tab>

                    </uib-tabset>





                </uib-tab>

                <uib-tab ng-show="1==2" heading="Dev">
                    <br />
                    <uib-tabset>

                        <uib-tab heading="LM Json">
                            <pre>{{SD | json}}</pre>
                        </uib-tab>

                        <uib-tab heading="TreeData">
                            <pre>{{treeData | json}}</pre>
                        </uib-tab>

                        <uib-tab heading="TreeData-links">
                            <table>
                                <tr><th>Id</th><th>Parent</th></tr>
                                <tr ng-repeat="row in treeData">
                                    <td>{{row.id}}</td>
                                    <td>{{row.parent}}</td>

                                </tr>
                            </table>
                        </uib-tab>


                    </uib-tabset>
                </uib-tab>


                <uib-tab ng-show="input.showComments">

                    <uib-tab-heading>Comments
                        <span class="badge"> {{taskList.length}}</span>
                    </uib-tab-heading>
                    <br/>



                        <div class="designerScroll">
                            <table class="table table-bordered">
                                <tr><th>Path</th><th>Comment</th><th># notes</th><th></th></tr>
                                <tr ng-repeat="task in taskList | orderBy: 'path'">
                                    <td>
                                        <div class="clickable" ng-click="selectNodeFromTable(task.currentPath)">{{task.currentPath | dropFirstInPath}}</div>
                                        <div ng-show="task.currentPath !== task.path">
                                            <em>({{task.path | dropFirstInPath}})</em>
                                        </div>

                                    </td>

                                    <td>

                                        {{task.description}}
                                        <div><em>{{task.requesterDisplay}}</em></div>
                                    </td>
                                    <!-- <td>{{task.requesterDisplay}}</td> -->
                                    <td> <span class="badge" ng-show="task.notes.length > 0"
                                               uib-popover="There are  {{task.notes.length}} notes on this comment"
                                               popover-placement="left"
                                               popover-trigger="'mouseenter'">
                                                {{task.notes.length}}</span></td>
                                    <td><i class="glyphicon glyphicon-edit clickable" ng-click="lmEditTask(task)"></i></td>
                                </tr>
                            </table>
                        </div>

                </uib-tab>



            </uib-tabset>
        </div>
        <div ng-class="rightPaneClass">

            <div ng-show="treeData.length > 0">
                <uib-tabset>
                    <uib-tab heading="Element">

                        <div ng-show="selectedNode">
                            <div class="row">
                                <div class="col-md-8 col-sm-8">
                                    <h4>{{selectedNode.text}}</h4>

                                </div>
                                <div class="col-md-4 col-sm-4">
                                    <div class="pull-right">
                                        <input style="margin-top: 15px"
                                               ng-click="setClinicalView(clinicalView)"
                                               type = "checkbox" ng-model="clinicalView"/> Clinical View
                                    </div>

                                </div>
                            </div>

                            <table class="table table-bordered">

                                <tr>
                                    <td width="20%">Path</td>
                                    <td>{{selectedNode.data.path}}


                                    </td>
                                </tr>

                                <tr>
                                    <td width="20%">Name</td>
                                    <td>{{selectedNode.data.name}}


                                    </td>
                                </tr>




                                <tr ng-show = "selectedNode.data.edStatus && (selectedNode.data.edStatus !== 'included')" class="required">
                                    <td>Status</td><td>{{selectedNode.data.edStatus}}

                                    <span class="pull-right"><em>{{statusDescription[selectedNode.data.edStatus]}}</em></span>


                                </td>
                                </tr>
                                <tr ng-show="selectedNode.data.lmReviewReason">
                                    <td>Reason for review</td>
                                    <td>
                                        {{selectedNode.data.lmReviewReason}}

                                    </td>
                                </tr>
                                <tr ng-show="selectedNode.data.alias">
                                    <td width="20%">Alias</td>
                                    <td>
                                        <ul>
                                            <li ng-repeat="al in selectedNode.data.alias track by $index">
                                                {{al}}
                                            </li>
                                        </ul>
                                    </td>
                                </tr>


                                <tr><td>Short</td><td>{{selectedNode.data.short}}</td></tr>
                                <tr><td>Description</td>
                                    <td>
                                        <div style="white-space: pre-line">{{selectedNode.data.description}}</div>
                                    </td>
                                </tr>


                                <tr>
                                    <td>Must Support</td>
                                    <td>
                                        <div ng-show="selectedNode.data.mustSupport">
                                            Yes
                                        </div>
                                        <div ng-hide="selectedNode.data.mustSupport">
                                            No
                                        </div>

                                    </td>
                                </tr>


                                <tr ng-show="selectedNode.data.usageGuide">
                                    <td>Usage Guide</td>
                                    <td>
                                        <div style="white-space: pre-line">{{selectedNode.data.usageGuide}}</div>


                                    </td>
                                </tr>
                                <tr ng-show="selectedNode.data.misuse">
                                    <td>Misuse</td>
                                    <td>
                                        <div style="white-space: pre-line">{{selectedNode.data.misuse}}</div>
                                    </td>
                                </tr>
                                <tr ng-show="selectedNode.data.legacy">
                                    <td>Legacy issues</td>
                                    <td>
                                        <div style="white-space: pre-line">{{selectedNode.data.legacy}}</div>
                                    </td>
                                </tr>


                                <tr ng-show="selectedNode.data.examples">
                                    <td>Examples</td>
                                    <td>
                                        <div style="white-space: pre-line">{{selectedNode.data.examples}}</div>
                                    </td>
                                </tr>

                                <tr ng-show="selectedNode.data.references">
                                    <td>References</td>
                                    <td>
                                        <div style="white-space: pre-line">{{selectedNode.data.references}}</div>
                                    </td>
                                </tr>


                                <tr ng-show="selectedNode.data.mappingFromED.length > 0 && ! clinicalView"><td>Mappings</td><td>
                                    <table class="table table-condensed table-bordered"  style="margin-bottom: 2px">
                                        <tr><th>Identity</th><th>Map</th><th>Comment</th></tr>
                                        <tr ng-repeat="map in selectedNode.data.mappingFromED">
                                            <td>{{map.identity}}</td>
                                            <td>{{map.map}}</td>
                                            <td>{{map.comment}}</td>
                                        </tr>
                                    </table>
                                    <!--{{selectedNode.data.mappingFromED}}
                                    <div ng-show="selectedNode.data.mapping"><em>{{selectedNode.data.mapping}}</em></div>-->
                                </td></tr>

                                <tr ng-show="selectedNode.data.lmElementLink">
                                    <td>Link to IG page</td>
                                    <td>
                                        <a ng-href="{{selectedNode.data.lmElementLink}}" target="_blank">
                                            {{selectedNode.data.lmElementLink}}
                                        </a>



                                    </td>
                                </tr>



                                <tr ng-show="selectedNode.data.fhirMappingExtensionUrl"><td>Extension Url</td>
                                <!--    <td>
                                        {{selectedNode.data.fhirMappingExtensionUrl}}
                                    </td>
-->
                                    <td>
                                        <a href="#" ng-click="editExtension(selectedNode.data.fhirMappingExtensionUrl)">{{selectedNode.data.fhirMappingExtensionUrl}}</a>
                                    </td>

                                </tr>

                                <tr ng-show="selectedNode.data.comments"><td>Comments</td>

                                    <td>
                                        <div style="white-space: pre-line">{{selectedNode.data.comments}}</div>
                                    </td></tr>

                                <tr><td>Multiplicity</td><td>{{selectedNode.data.min}}..{{selectedNode.data.max}}</td></tr>
                                <tr ng-show="selectedNode.data.analysis">
                                    <td>Extension data</td>
                                    <td>{{selectedNode.data.analysis | json}}</td>
                                </tr>
                                <tr><td>Datatypes</td>
                                    <td>
                                    <div ng-repeat = "typ in selectedNode.data.type">


                                        <div ng-hide = "typ.code == 'Reference'">

                                            <!-- todo - get rid of hard coded Dosage here-->
                                            <a ng-show="typ.code == 'Dosage'" href="http://hl7.org/fhir/dosage.html" target="_blank">
                                                <i class="glyphicon glyphicon-eye-open clickable"></i>
                                            </a>

                                            <a ng-hide="typ.code == 'Dosage'" ng-href="{{rootForDataType}}{{typ.code}}" target="_blank">
                                                <i class="glyphicon glyphicon-eye-open clickable"></i>
                                            </a>


                                            {{typ.code}}
                                            <span class="clickable pull-right"
                                                   ng-click="viewDataType(typ.code)">View elements</span>
                                        </div>



                                        <!-- targetProfile is now multiple in internal model (Jan 2019) -->
                                        <div ng-show = "typ.code == 'Reference'">
                                            <div ng-repeat = 'targetProfile in typ.targetProfile'>
                                                    <span ng-show="isCoreType(targetProfile)">
                                                    <a ng-href="{{fhirRoot}}{{targetProfile | getLogicalID}}.html" target="_blank">
                                                        <!--<a ng-href="http://hl7.org/fhir/{{targetProfile | getLogicalID}}.html" target="_blank">-->

                                                        <i class="glyphicon glyphicon-eye-open clickable"></i>
                                                    </a>

                                                </span>


                                                <span class="clickable pull-right" ng-click="viewReferencedModel(targetProfile)">View elements</span>
                                                Reference -> {{targetProfile | getLogicalID}}
                                            </div>

<!--
                                            <a href="#" ng-click="explodeReference(selectedNode)">Explode</a>

-->

                                        </div>
                                    </div>
                                    <!-- If there's a ValueSet defined, allow it to be selected... -->
                                    <span ng-show="selectedNode.data.selectedValueSet">

                                         <span class="clickable" ng-click="viewVS(selectedNode.data.selectedValueSet.valueSet)">
                                            {{selectedNode.data.selectedValueSet.valueSet}}</span>
                                            ({{selectedNode.data.selectedValueSet.strength}})

                                    </span>


                                </td>


                                </tr>


                                <tr ng-show="selectedNode.data.idFromSD && input.showComments">
                                    <td>User Comments</td>
                                    <td>
                                        <div ng-controller="taskCtrl">
                                            <ng-include src="'/includes/tasksOneElement.html'"></ng-include>
                                        </div>

                                    </td>
                                </tr>

                                <tr ng-show="selectedNode.data.conceptMap">
                                    <td>ConceptMap</td>
                                    <td><a href="#" ng-click="showConceptMap(selectedNode.data.conceptMap)">{{selectedNode.data.conceptMap}}</a></td></tr>

                                <tr ng-show="selectedNode.data.mapping"><td>Mapping notes</td><td>
                                    {{selectedNode.data.mapping}}


                                </td></tr>
                                <tr ng-show="selectedNode.data.fixedString">
                                    <td>Fixed</td><td>{{selectedNode.data.fixedString}}</td>
                                </tr>
<!--
                                <tr ng-show="selectedNode.data.discriminator">
                                    <td>Discriminator</td><td>{{selectedNode.data.discriminator}}</td>
                                </tr>
-->
                                <tr><td>Actions</td><td>


                                    <div ng-show="!Practitioner">
                                        Not logged in - read only mode
                                    </div>

                                    <div ng-show ="isHistory">
                                        Viewing Historical value, read only mode
                                    </div>

                                    <div ng-show = "treeData[0].data.header.editor && (Practitioner.telecom[0].value !== treeData[0].data.header.editor)">
                                        The model editor is {{treeData[0].data.header.editor}}. Only they can make changes
                                    </div>

                                    <div ng-show = "canEdit()">
                                        <span>
                                        <i class="glyphicon glyphicon-arrow-up clickable"
                                           ng-hide = "$index == 0 || isHistory"
                                           uib-popover="Move upwards. Cannot move beyond the parent"
                                           popover-placement="top"
                                           popover-trigger="'mouseenter'"
                                           ng-click="moveUp($event,$index)" style="margin-right: 10px"></i>

                                        <i class="glyphicon glyphicon-arrow-down clickable"
                                           ng-hide = "$index == (config.sections.length -1) || isHistory"
                                           uib-popover="Move downwards. Cannot move beyond the parent"
                                           popover-placement="top"
                                           popover-trigger="'mouseenter'"
                                           ng-click="moveDn($event,$index)"></i>

                                        <i class="glyphicon glyphicon-arrow-left clickable"
                                           ng-show="segmentCount(selectedNode.data.path) > 2 "
                                           uib-popover="Move up the hierarchy."
                                           popover-placement="top"
                                           popover-trigger="'mouseenter'"
                                           ng-click="moveLeft()"></i>

                                         <i class="glyphicon glyphicon-arrow-right clickable"
                                            ng-show="segmentCount(selectedNode.data.path) > 1 "
                                            uib-popover="Move down the hierarchy."
                                            popover-placement="top"
                                            popover-trigger="'mouseenter'"
                                            ng-click="moveRight()"></i>

                                    </span>

                                        <button ng-show="!selectedNode.data.isRoot && !isHistory"
                                                class="btn btn-link" ng-click="editNode()">Edit Element</button>


                                        <button ng-show="!isHistory" class="btn btn-link" ng-click="addNode()">Add Element</button>

                                        <button ng-show="!selectedNode.data.isRoot  && !isHistory"
                                                class="btn btn-link" ng-click="deleteNode()">Remove Element</button>


                                        <button ng-show="!selectedNode.data.isRoot  && !isHistory"
                                                class="btn btn-link" ng-click="copyNode()">Copy Element</button>
                                        <!-- todo work on in madrid-->

                                        <div>
<!--
                                            <button ng-show="!selectedNode.data.isRoot && !isHistory &&
                                                (selectedNode.data.path.split('.').length==2)"
                                                    class="btn btn-link" ng-click="cloneNode(selectedNode)">Copy Element</button>

                                            -->

                                            <!-- temp - don't delete, but not sure if this is needed...
                                            <button ng-show="discriminatorReq" class="btn btn-link"
                                                    uib-popover="Use the value of this element as the discriminator for all elements with the same path"
                                                    popover-placement="top"
                                                    popover-trigger="'mouseenter'"
                                                    ng-click="setAsDiscriminator(selectedNode)">Set as Discriminator</button>


                                            -->
                                        </div>



                                    </div>


                                    <div ng-show="input.graphTabIsSelected">
                                        <span>Map display options: </span>
                                        <button class="btn btn-link" ng-click="setParentInGraph(selectedNode)">Hide other nodes</button>
                                        <button class="btn btn-link" ng-click="resetGraph()">Reset</button>
                                    </div>



                                </td></tr>
                                <tr ng-show="valueSetOptions">
                                    <td>Options</td>
                                    <td>

                                        <div ng-show="valueSetOptions.length == 1">
                                            {{valueSetOptions[0].display}}
                                        </div>

                                        <ul ng-hide = "valueSetOptions.length == 1">
                                            <li ng-repeat="option in valueSetOptions">{{option.display}}

                                                <span ng-show="option.code" class="clickable" ng-click="showCodeDetails(option)">({{option.code}})</span></li>
                                        </ul>

                                    </td>
                                </tr>
                            </table>
<!--
                            <pre>{{selectedNode | json}}</pre>
-->
                        </div>


                    </uib-tab>

                    <uib-tab heading="Model">


                        <h4>Model properties</h4>
                        <div><span ng-click = "editModel()" class="clickable pull-right">Edit</span> </div>
                        <uib-tabset>
                            <br/>
                            <uib-tab heading="Summary">
                                <br/>
                                <table class="table table-bordered">

                                    <tr ng-show="treeData[0].data.header.baseType">
                                        <td>Base Resource Type</td><td>{{treeData[0].data.header.baseType}}</td></tr>

                                    <tr><td width="25%">Model Name</td><td>{{treeData[0].data.header.name}}</td></tr>
                                    <tr><td>Model Url</td><td>{{treeData[0].data.header.SDUrl}}</td></tr>
                                    <tr><td>Model ID on server</td><td>{{treeData[0].data.header.SDID}}</td></tr>
                                    <tr><td>Model Title</td><td>{{treeData[0].data.header.title}}</td></tr>
                                    <tr><td>Model Purpose</td><td>{{treeData[0].data.header.purpose}}</td></tr>
                                    <tr ng-show="treeData.shortCut.shortCut">
                                        <td>Shortcut</td>
                                        <td>
                                            {{treeData.shortCut.shortCut}}
                                            <div><a href="#" ng-click="generateShortCut()">Replace</a></div>
                                        </td>
                                    </tr>


                                    <tr>
                                        <td>Model Editor</td>
                                        <td>

                                                <div ng-show="((Practitioner.telecom[0].value.toLowerCase() == treeData[0].data.header.editor.toLowerCase()) || Practitioner.telecom[0].value && !  treeData[0].data.header.editor)">
                                                <!-- IF the current user is the editor, or there is a current user but no editor-->

                                                <div style="cursor: hand" class="pull-right clickable"  ng-click="changeEditor()">Change</div>
                                            </div>

                                            {{treeData[0].data.header.editor}}
                                        </td>
                                    </tr>

                                    <tr ng-show="((Practitioner.telecom[0].value == treeData[0].data.header.editor) ||
                                            Practitioner.telecom[0].value && !  treeData[0].data.header.editor)">
                                        <td>Allow comments</td>
                                        <td>
                                               <checkbox ng-model="input.showComments" ng-click="setAllowComments(input.showComments)"></checkbox>

                                        </td>
                                    </tr>

                                    <tr ng-show="((Practitioner.telecom[0].value == treeData[0].data.header.editor) ||
                                            Practitioner.telecom[0].value && !  treeData[0].data.header.editor)">
                                        <td>Delete model</td>
                                        <td>

                                            <button class="btn btn-danger" ng-click="deleteModel()">Delete Model</button>

                                        </td>
                                    </tr>


                                    <tr ng-show="treeData[0].data.header.mapping">
                                        <td>Mapping</td><td>{{treeData[0].data.header.mapping}}</td></tr>




                                </table>
                            </uib-tab>



                            <uib-tab heading="History">
                                <br/>

                                <div class="designerScroll">
                                    <ul class="list-group">
                                        <li style="cursor: pointer" ng-class="{'list-group-item':1==1,'list-group-item-info':false}"
                                            ng-repeat="entry in modelHistory.entry"
                                            ng-click="selectModelVersion(entry,$index)">

                                            <div class="row">
                                                <div class="col-md-4 col-sm-4 clickable" >
                                                    {{entry.resource.meta.lastUpdated | date:'medium'}}
                                                </div>
                                                <div class="col-md-4 col-sm-4">
                                                    {{entry.resource.extension | extensionValue : 'http://clinfhir.com/fhir/StructureDefinition/editor'}}

                                                    {{entry.resource.extension | extensionValue : 'http:www.clinfhir.com/StructureDefinition/userEmail'}}
                                                </div>
                                                <div class="col-md-4 col-sm-4">
                                                    <span class="pull-right">{{entry.resource.meta.lastUpdated | getAgeSeconds}}</span>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>

                                </div>


                            </uib-tab>





                        </uib-tabset>

                    </uib-tab>

                    <uib-tab ng-show = "selectedNode && debug" heading="TreeJson">
                        <pre>{{selectedNode | json}}</pre>
                    </uib-tab>

                    <uib-tab ng-show = "selectedNode && debug" heading="EDJson">
                        <pre>{{selectedED | json}}</pre>
                    </uib-tab>


                </uib-tabset>

            </div>
        </div>




         <vs-browser trigger="showVSBrowserDialog" hidesearch="true"
                vs-selected="vsSelected"></vs-browser>

        </div>


</div>
</body>
</html>