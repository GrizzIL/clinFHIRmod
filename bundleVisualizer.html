<!DOCTYPE html>
<html>
<head lang="en">
    <base href="/" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YD055VEN8K"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YD055VEN8K');
    </script>

    <meta charset="UTF-8">
    <script src="js/libs/jquery-1.9.0.min.js"></script>
    <script src="js/libs/angular.min1-5.js"></script>
    <script src="js/libs/ui-bootstrap-tpls-2.0.1.min.js"></script>

    <script src="js/libs/moment.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/jsTreeStyle.css"/>
    <link rel="stylesheet" type="text/css" href="css/jsTreeThemes/proton/style.css"/>

    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="stylesheet" type="text/css" href="css/vis.min.css"/>

    <script src="js/libs/angular-sanitize.js"></script>
    <script src="js/libs/firebase.js"></script>
    <script src="js/libs/angularfire.min.js"></script>
    <script src="js/libs/angular-sanitize.js"></script>
    <script src="js/libs/jstree.min.js"></script>
<!--
    <script src="js/libs/handlebars-v4.1.2.js"></script>
    -->



    <style>
        .popover-content {
            max-width: 400px;
        }

        .resourceType {
            border: 1px solid darkgrey; padding: 2px;
        }
    </style>


    <script>
        angular.module("sampleApp",['ui.bootstrap','ngStorage','firebase','ngSanitize','ui.checkbox']).config(function($locationProvider) {
            $locationProvider.html5Mode(true);
            $locationProvider.hashPrefix('!');
        });
        angular.module("sampleApp").constant("moment", moment);

    </script>

    <script>
        var config = {
            apiKey: "AIzaSyBNMohLbPiSKwpGwfARopdeW_6LLXujcUo",
            authDomain: "clinfhir.firebaseapp.com",
            databaseURL: "https://clinfhir.firebaseio.com",
            storageBucket: ""
        };

        if (firebase) {
            firebase.initializeApp(config);

        }
    </script>
    <script src="js/loginCtrl.js"></script>
    <script src="js/bundleVisualizerCtrl.js"></script>
    <script src="js/v2ToFhirSvc.js"></script>
    <script src="js/libs/vis.min.js"></script>
    <script src="js/modalDialogSvc.js"></script>
    <script src="resourceBuilder/rbServices.js"></script>
    <script src="js/libs/angular-bootstrap-checkbox.js"></script>

    <style>
        .myForm {
            padding: 8px;
        }
        .modelScroll {
            height: 500px;
            overflow-y: scroll;
        }
        .entryListScroll {
            height: 500px;
            overflow-y: scroll;
        }
        #resourceGraph {
            width: 100%;
            height: 550px;
            border: 1px solid lightgray;
        }

        #canonicalGraph {
            width: 100%;
            height: 550px;
            border: 1px solid lightgray;
        }


        #singleResourceGraph {
            width: 100%;
            height: 550px;
            border: 1px solid lightgray;
        }

        table {
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid black;
            padding: 5px;
        }

        th {
            font-weight: bold;
        }
        thead {
            font-weight: bold;
        }

    </style>

    <script src="js/modalDialogSvc.js"></script>
    <script src="js/appConfigSvc.js"></script>
    <script src="js/libs/ngStorage.min.js"></script>
    <script src="js/filters.js"></script>
    <script src="js/bundleVisualizerCtrl.js"></script>

    <title>Bundle Viewer</title>

</head>


<body style="padding: 8px;padding-top: 80px" >

<div ng-app="sampleApp" ng-controller="bundleVisualizerCtrl" class="container-fluid">

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">

        <div class="container-fluid">
            <div class="col-md-2 ">
                <span>
                    <a class="navbar-brand" href="#" ng-click="showVersion()">
                        Bundle visualizer
                    </a>
                </span>

            </div>
            <div class="col-md-2">
                <div class="navbar-text">
                    <div ng-hide = "showSelector || urlPassedIn" class="clickable" ng-click="showSelector = true">Show Selector</div>
                </div>
            </div>

<!--
            <div class="col-md-5">
                <div class="navbar-text">
                    <strong>Validation server:</strong> {{validationServer.name}} ({{validationServer.url}}) <span class="clickable" ng-click="changeServer('validation')">Change</span>

                    <div><strong>Data and XML Conversion server:</strong> {{dataServer.name}} ({{dataServer.url}}) <span class="clickable" ng-click="changeServer('convert')">Change</span> </div>
                </div>

            </div>
-->
            <div class="col-md-2">

            </div>


            <div class="col-md-1">
                <!--
                <div class="navbar-text">
                    <div ng-show="fhir">
                        <div class="clickable" ng-hide="input.showHelp" ng-click="input.showHelp = true">Show Help</div>
                        <div class="clickable" ng-show="input.showHelp" ng-click="input.showHelp = false">Hide Help</div>
                    </div>
                </div>
                -->
            </div>


            <div class="col-md-1">
                <form class="navbar-form navbar-left">
                    <img ng-show="waiting" src="css/ajax_loader_blue_32.gif"/>
                </form>
            </div>

            <div class="col-md-1 col-sm-1">


                <div class="nav navbar-form navbar-right" ng-hide="firebase.auth().currentUser">
                <span style="font-size:1.8em; cursor: pointer">
                    <div ng-click="login()">
                        <i class="glyphicon glyphicon-log-in clickable"></i>
                    </div>
                </span>
                </div>

                <div class="nav navbar-form navbar-right" ng-show="firebase.auth().currentUser">
                    <span style="font-size:1.8em; cursor: pointer"
                          uib-popover="{{firebase.auth().currentUser.email}}"
                          popover-placement="left"
                          popover-trigger="'mouseenter'">

                        <div ng-click="logout()"> <i class="glyphicon glyphicon-log-out clickable"></i></div>
                    </span>
                </div>

            </div>
<!--
            <div class="col-md-1">
                <form class="navbar-form navbar-left">
                    <i class="glyphicon glyphicon-cog clickable"
                       style="padding: 10px"
                       ng-click="showConfig">

                    </i>
                </form>
            </div>
            -->

            <div class="col-md-3">
                <div class="navbar-text pull-right">
                    <a href="https://www.lyniate.com/" target="_blank">
                        <img  src="/icons/supported_by_lyniate.png"/>
                    </a>

                </div>

            </div>

        </div>
    </nav>

    <div ng-show = "showSelector">

        <uib-tabset>
            <uib-tab>
                <uib-tab-heading>
                    Saved Bundles & Queries <span class="badge">{{userBundles.entry.length}}</span>
                </uib-tab-heading>

                <div class="row">
                    <div class="col-md-6">
                        <div ng-hide="user">
                            <br/>
                            <p>You need to log in using the icon on the navbar (or click here:

                                <span ng-click="login()">
                                <i class="glyphicon glyphicon-log-in clickable"></i>
                            </span>

                                ) to be able to save Bundles and Queries for later
                                use.</p>
                            <p>You can still paste in a Bundle - or locate one using a query -
                                from the two tabs above and it will still work just fine, but it won't be saved in your
                                personal account.</p>
                        </div>

                        <div  ng-show="user">
                            <h4>Saved bundles</h4>

                            <table class="table table-bordered">
                                <tr ng-repeat = "item in savedBundles">
                                    <td>{{item.name}}</td>
                                    <td width="80"><button class="btn btn-link" ng-click="displaySavedBundle(item)">Load</button> </td>
                                </tr>
                            </table>


                            <h4>Saved queries</h4>
                            <table class="table table-bordered">
                                <tr ng-repeat = "item in savedQueries">
                                    <td>{{item.name}}</td>
                                    <td>{{item.qry}}</td>
                                    <td width="80"><button class="btn btn-link" ng-click="executeSavedQuery(item)">Execute</button> </td>
                                </tr>
                            </table>
                        </div>

                        <div><em>Saved bundles and queries are stored on the data server - currently {{dataServer.name}} ({{dataServer.url}}). </em></div>

                        <em>Bundles are stored at the [host]/Bundle endpoint, and queries at [host]/DocumentReference</em>


                    </div>
                    <div class="col-md-6">
                        <h4>Configuration</h4>

                        <div><strong>Data server:</strong> {{dataServer.name}} ({{dataServer.url}}) <span class="clickable" ng-click="changeServer('data')">Change</span> </div>
                        <p>The data server serves 2 main purposes:</p>
                        <ul>
                            <li>Saved bundles and queries are stored there.</li>
                            <li>It is the 'default' server when creating a query. You can however specify any server you want by using the
                                full url when creating the query.</li>
                        </ul>

                        <strong>Validation server:</strong>

                        {{validationServer.name}} ({{validationServer.url}}) <span class="clickable" ng-click="changeServer('validation')">Change</span>
                        <p>Used when validating the bundle and its contents. This occurs automatically when a bundle is processed and displayed. </p>
                        <br/>

                    </div>
                </div>



            </uib-tab>


            <uib-tab heading = "Paste in bundle">
                <div class="row">
                    <div class="col-md-4">
                        <br/>
                        <p>Paste a bundle into the text area to the right. </p>
                        <p>A button will appear below that when clicked will show the contents in the Visualizer.</p>
                        <p>Either Json or XML can be used. XML will be converted to Json (using the <a href="https://github.com/lantanagroup/FHIR.js">Lantana</a> library) before
                        being displayed.</p>

                        <button ng-show = "input.newBundle" class="btn btn-success"
                                ng-click="viewNewBundle(input.newBundle)">View bundle</button>

                        <div ng-show = "user">

                            <label>Bundle name</label>
                            <input type="text" ng-model="input.newBundleName" class="form-control"
                                   placeholder="Bundle name, if to be saved"/>

                            <span class="help-block pull-right">Required if the bundle is to be saved</span>

                            <button ng-show = "executedQueryBundle && input.newBundleName && user" class="btn btn-danger"
                                    ng-click="viewNewBundle(input.newBundle,input.newBundleName)">Save and view</button>





                        </div>

<!--
                        <div><button class="btn btn-primary"
                                     ng-click="viewNewBundle(input.newBundle,input.newBundleName)">
                            View Bundle</button></div>
                        -->
                    </div>
                    <div class="col-md-8">
                        <textarea class="form-control" rows = '20' ng-model="input.newBundle"></textarea>
                    </div>

                </div>


            </uib-tab>
            <uib-tab heading = "Enter query url">
                <br/>

                <div class="row">
                    <div class="col-md-6">
                        <p>Enter a query that returns a FHIR bundle</p>
                        <p>The query can be to a FHIR server or standard server (like a bundle stored in Github)</p>
                        <p>You can use the currently configured data server ({{dataServer.url}}) or any other server. To specify another server
                            simply use the full url - eg http://myserver/mybundle. If you leave off the 'http' the app will assume
                            you are making standard <a href="http://hl7.org/fhir/http.html#search" target="_blank">FHIR query</a> (Only a GET is supported)</p>
                        <p>You can change the configured server <span class="clickable">here.</span> </p>
                        <p>If you want to save the query (so it will appear in your personal list, you need to be logged in,
                        and specify a name in the box below.</p>

                        <!--
                        <label>Data server url</label>
                        <div>{{dataServer.url}}</div>
                        -->
                        <br/><br/>
                        <label>Query to execute</label>
                        <input class="form-control" ng-model="input.newQuery" placeholder="The query."/>
                        <span class="help-block pull-right">Use full query (incl. http) if to a different server</span>

                        <br/><br/>
                        <label>Query name</label>
                        <div>
                            <input class="form-control" ng-model="input.newQueryName" placeholder="A name for the query (required if query is to be saved"/>
                        </div>
                        <span class="help-block pull-right">Required if the query is to be saved</span>
                        <br/><br/>

                        <div>
                            <button ng-show = "input.newQuery && ! testQueryBundle" class="btn btn-primary"
                                    ng-click="testNewQuery(input.newQuery)">Test query</button>

                            <button ng-show = "executedQueryBundle" class="btn btn-warning"
                                    ng-click="clearQuery()">Clear</button>

                            <button ng-show = "executedQueryBundle && input.newQueryName && user" class="btn btn-danger"
                                    ng-click="addNewQuery(input.newQuery,input.newQueryName)">Add query to list</button>

                            <button ng-show = "executedQueryBundle" class="btn btn-success"
                                    ng-click="viewNewQueryBundle(executedQueryBundle)">View bundle</button>
                        </div>

                        <br/>
                        <strong ng-show="executedQuery">Executed query</strong>
                        <div>{{executedQuery}}</div>
                    </div>
                    <div class="col-md-6">
                        <pre>{{executedQueryBundle | json}}</pre>
                    </div>



                </div>
            </uib-tab>

        </uib-tabset>

    </div>

    <div ng-hide = "showSelector" class="row">

        <div ng-class="col-md-12">
         <!--   <div ng-class="rightPaneClass">-->

            <div ng-show="!fhir || input.showHelp">
                <br/>
                <strong>Adding a bundle to view</strong>
                <br/> <br/>
                The left pane allows 2 ways to add a bundle to the visualizer.
                <ul>
                    <li>A bundle can be pasted in directly by clicking the 'Import Bundle'.
                        Json bundles are processed directly. XML bundles are saved to the Data server, and then retrieved as Json.
                        In either case the bundle can be saved to the bundle list by supplying an identifier.</li>
                    <li>A query can be entered that will call the REST API of a server to return the bundle. The format
                        must be Json and the server must support CORS.</li>
                </ul>



                <strong>Strategy for determining references between resources</strong>
                <br/> <br/>
                <ul>
                    <li>If an entry has a fullUrl (preferred), then this will become the id of the resource from the
                        perspective of a reference target. Otherwise
                        the data server root, resource type and resource id are combined to make an absolute url to act as the id </li>
                    <li>If a reference is relative, it is combined with the server root to make it absolute.</li>
                </ul>

                <a href="https://docs.google.com/document/d/1bwyRKU100m8VOM30bcR_6bUms8FaC13SMrPAK5o6IR8/edit#" target="_blank">Link to on-line docs</a>
            </div>


                    <div>

                        <button class="btn btn-link pull-right" ng-show="fhir"
                                ng-click="copyToClipboard()">Copy bundle to Clipboard</button>

                    </div>

                    <uib-tabset ng-show="fhir">

                        <uib-tab>
                            <br/>
                            <uib-tab-heading>
                                Bundle entries <span class="badge">{{fhir.entry.length}}</span>
                            </uib-tab-heading>



                            <div class="row">
                                        <div class="col-md-4">

                                            <uib-tabset>
                                                <uib-tab heading="Bundle Order">

                                                    <div class="entryListScroll">


                                                        <div class="list-group">
                                                            <div ng-class="{'list-group-item':true,'listItemSelected':selectedBundleEntry == entry}" ng-repeat="entry in fhir.entry"
                                                                 ng-click="selectBundleEntry(entry,hashErrors[$index])">

                                                                <strong>{{entry.resource.resourceType}}</strong>

                                                                <span class="pull-right badge">{{hashErrors[$index].length}}</span>
                                                                <div>{{entry.resource.text.div | cleanTextDiv | limitTo:50}}</div>
<!--
                                                                <div><em>{{entry.fullUrl}}</em></div>
                                                                -->
                                                                <div style="padding-left: 10px"><em>Id: {{entry.resource.id}}</em></div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </uib-tab>
                                                <uib-tab heading="Resource Type">
                                                    <div class="entryListScroll">
                                                        <div ng-repeat="(k,v) in hashEntries">
                                                            <div><strong>{{k}}</strong></div>
                                                            <div ng-repeat = "entry in v">
                                                                <div style="padding-left: 10px; cursor: pointer"
                                                                     ng-click="selectBundleEntry(entry,hashErrors[$index])">
                                                                    <div> {{entry.resource.text.div | cleanTextDiv | limitTo:50}}</div>
                                                                    <div style="padding-left: 10px"><em>Id: {{entry.resource.id}}</em></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </uib-tab>
                                            </uib-tabset>



                                        </div>




                                        <div class="col-md-8">

                                            <div class="pull-right">
                                                <a target="_blank"
                                                   ng-show="selectedBundleEntry"
                                                   ng-href="http://hl7.org/fhir/{{selectedBundleEntry.resource.resourceType}}.html#resource">{{selectedBundleEntry.resource.resourceType}} Spec</a>
                                            </div>

                                            <uib-tabset>
                                                <uib-tab heading="Json">
                                                    <pre>{{selectedBundleEntry.resource | json}}</pre>
                                                </uib-tab>
                                                <uib-tab heading="Entry">
                                                    <pre>{{selectedBundleEntry | json}}</pre>
                                                </uib-tab>

                                                <uib-tab heading="Text">
                                                    <p ng-bind-html="selectedBundleEntry.resource.text.div"></p>


                                                </uib-tab>


                                                <uib-tab heading="Tree">
                                                    <br/>

                                                    <div id="builderResourceTree"></div>

                                                </uib-tab>

                                                <uib-tab heading="References"  select="fitSingleGraph()">
                                                    <br/>
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div uib-popover="If checked will include all resources that have a reference to the selected one."
                                                                 popover-placement="top"
                                                                 popover-trigger="'mouseenter'">
                                                                Show inward references <checkbox ng-model="input.showInRef" ng-change="createGraphOneEntry()"></checkbox>
                                                            </div>

                                                        </div>
                                                        <div class="col-md-4">
                                                            <div uib-popover="If checked will include all resources that are references by the selected one."
                                                                 popover-placement="top"
                                                                 popover-trigger="'mouseenter'">
                                                                Show outward references <checkbox ng-model="input.showOutRef" ng-change="createGraphOneEntry()"></checkbox>
                                                            </div>

                                                        </div>
                                                        <div class="col-md-4">
                                                            <div  uib-popover="If checked will include all resources connected to the selected resource, and all references between them."
                                                                  popover-placement="top"
                                                                  popover-trigger="'mouseenter'">
                                                                Recursive references <checkbox ng-model="input.recursiveRef" ng-change="createGraphOneEntry()"></checkbox>

                                                            </div>
                                                        </div>
                                                    </div>
                                                    <br/>
                                                    <div id="singleResourceGraph"></div>
                                                </uib-tab>

                                                <uib-tab ng-show="selectedBundleEntryErrors.length > 0">
                                                    <uib-tab-heading>
                                                        Errors <span class="badge">{{selectedBundleEntryErrors.length}}</span>
                                                    </uib-tab-heading>
                                                    <br/>
                                                    <div>
                                                        <em class = "pull-right">Validation Server: {{validationServer.url}}</em>
                                                    </div>

                                                    <div uib-alert class="alert-warning">
                                                        <table class="table">
                                                            <tr ng-repeat="err in selectedBundleEntryErrors">
                                                                <td>{{err.severity}}</td>
                                                                <td>
                                                                    {{err.diagnostics}}
                                                                    {{err.details.text}}
                                                                    <div ng-repeat = "ex in err.expression">
                                                                        {{ex}}
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div ng-repeat="location in err.location">
                                                                        {{location}}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                </uib-tab>

                                                <uib-tab ng-show="selectedBundleEntry.resource.resourceType == 'ValueSet' && selectedBundleEntry.resource.expansion">

                                                    <uib-tab-heading>
                                                        Expansion <span class="badge">{{selectedBundleEntry.resource.expansion.contains.length}}</span>
                                                    </uib-tab-heading>

                                                    <table class="table table-condensed">
                                                        <tr ng-repeat = "concept in selectedBundleEntry.resource.expansion.contains">
                                                            <td>
                                                                {{concept.code}}
                                                                <div>{{concept.system}}</div>
                                                                <div>{{concept.version}}</div>
                                                            </td>
                                                            <td>{{concept.display}}</td>
                                                        </tr>
                                                    </table>
                                                </uib-tab>

                                                <uib-tab ng-show="hashRefsByResource[selectedBundleEntry.resource.id].length > 0">
                                                    <uib-tab-heading>
                                                        Canonicals <span class="badge">{{hashRefsByResource[selectedBundleEntry.resource.id].length}}</span>

                                                    </uib-tab-heading>

                                                    <pre>{{hashRefsByResource[selectedBundleEntry.resource.id] | json}}</pre>

                                                </uib-tab>

                                            </uib-tabset>
                                        </div>

                                    </div>


                        </uib-tab>


                        <uib-tab heading = "References Graph" select="fitGraph()">
                            <div class="row">
                                <div class="col-md-8">
                                    <!--
                                    <div>
                                        <div class="pull-right">
                                            <input ng-model="input.showHidePatient" type="checkbox"
                                                   ng-click="showHidePatient(input.showHidePatient)"/> Hide Patient
                                        </div>
                                    </div>
                                    -->

                                    <div id="resourceGraph"></div>
                                </div>
                                <div class="col-md-4">

<!-- todo - selectedBundleEntryErrors not being created on graph select-->
                                    <!--
                                    <div uib-alert class="alert-warning" ng-show="selectedBundleEntryErrors.length > 0">
                                        <table class="table">
                                            <tr ng-repeat="err in selectedBundleEntryErrors">
                                                <td>{{err.severity}}</td>
                                                <td>{{err.diagnostics}}</td>
                                                <td>
                                                    <div ng-repeat="location in err.location">
                                                        {{location}}
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>

                                    -->

                                    <uib-tabset>
                                        <uib-tab heading="Resource">
                                            <pre>{{selectedNode.entry.resource | json}}</pre>
                                        </uib-tab>
                                        <uib-tab heading="Entry">
                                            <pre>{{selectedNode.entry | json}}</pre>
                                        </uib-tab>
                                    </uib-tabset>



                                </div>
                            </div>

                        </uib-tab>

                        <uib-tab heading = "Canonical graph"  select="fitSingleGraph()">
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="row">

                                        <div class="col-md-12">
                                            <button class="btn btn-link pull-right" ng-click="fitCanonicalGraph()">Refresh graph (if no display)</button>
                                        </div>
                                    </div>
                                    <div id="canonicalGraph"></div>
                                </div>
                                <div class="col-md-5">
                                    <uib-tabset>
                                        <uib-tab heading="Json">
                                            <pre>{{selectedCanResource | json}}</pre>
                                        </uib-tab>
                                        <uib-tab ng-show="selectedCanResource.resourceType == 'ValueSet' && selectedCanResource.expansion">

                                            <uib-tab-heading>
                                                Expansion <span class="badge">{{selectedCanResource.expansion.contains.length}}</span>
                                            </uib-tab-heading>

                                            <table class="table table-condensed">
                                                <tr ng-repeat = "concept in selectedCanResource.expansion.contains">
                                                    <td>
                                                        {{concept.code}}
                                                        <div>{{concept.system}}</div>
                                                        <div>{{concept.version}}</div>
                                                    </td>
                                                    <td>{{concept.display}}</td>
                                                </tr>
                                            </table>
                                        </uib-tab>

                                        <uib-tab ng-show="hashRefsByResource[selectedCanResource.id].length > 0">
                                            <uib-tab-heading>
                                                Canonicals <span class="badge">{{hashRefsByResource[selectedCanResource.id].length}}</span>

                                            </uib-tab-heading>

                                            <pre>{{hashRefsByResource[selectedCanResource.id] | json}}</pre>

                                        </uib-tab>
                                    </uib-tabset>
                                </div>
                            </div>

                        </uib-tab>

                        <uib-tab ng-show = "false" heading="Bundle validation">
                            <div class="row">
                                <div class="col-md-10">

                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary" ng-click="validateBundle()">Validate</button>
                                </div>
                            </div>


                            <pre>{{hashErrors | json}}</pre>


                            <table class="table table-condensed">
                                <tr ng-repeat="iss in bundleValidationResult.issue">
                                    <td>{{iss.severity}}</td>
                                    <td>{{iss.diagnostics}}</td>
                                    <td>
                                        <div ng-repeat="loc in iss.location">
                                            {{loc}}
                                        </div>
                                    </td>
                                </tr>
                            </table>
                            <pre>{{bundleValidationResult | json}}</pre>
                        </uib-tab>


                        <uib-tab ng-show = "fhir.type == 'document'" heading="Document">

                            <strong>Subject</strong>
                            <p  style="margin-left: 10px" ng-bind-html="document.subject.text.div"></p>

                            <strong>Document metadata</strong>
                            <p  style="margin-left: 10px" ng-bind-html="document.composition.text.div"></p>

                            <div ng-repeat = "section in document.composition.section">
                                <hr style="border-top: 1px solid grey; margin: 1px"/>
                                <strong>{{section.title}}</strong>

                                <div class="row">

                                    <div class="col-md-5">
                                        <p style="margin-left: 10px" ng-bind-html="section.text.div"></p>
                                    </div>
                                    <div class="col-md-6">
                                        <div ng-repeat = "resource in section.realResources">
                                            <div class="rounded-box">
                                                {{resource.display}}
                                                <em><p ng-bind-html="resource.resource.text.div"></p></em>
                                            </div>
                                        </div>
                                    </div>
                                </div>





                            </div>

                            <div><em>Derived from the Composition and Subject text elements as per the spec</em></div>

                        </uib-tab>


                        <uib-tab ng-show = "false" heading="Table">

                            <div class="row" style="margin-top: 8px"  ng-repeat = "entry in fhir.entry">
                                <div class="col-md-3">

                                    <span class = "resourceType"> {{entry.resource.resourceType}}</span>
                                </div>

                            </div>


                        </uib-tab>


                        <uib-tab heading="Json">
                            <div>
                                <pre ng-show="fhir">  {{fhir | json}} </pre>

                            </div>
                        </uib-tab>


<!--
                        <uib-tab ng-show = "1==2 && fhir.type == 'document' " heading="HandleBars Document">

                            <button class="btn btn-primary" ng-click="hbDoc()">Load HandleBars template and render document</button>
                            <hr/>


                            <ng-include src="hbTemplate"></ng-include>
                        </uib-tab>
                        -->



                    </uib-tabset>





        </div>



    </div>












</div>
</body>
</html>